/*
 * File: app/controller/Device.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('NeoDoc.controller.Device', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            ref: 'deviceCreateWindow',
            selector: 'devicecreatewindow'
        },
        {
            ref: 'MainTabPanel',
            selector: 'maintabpanel'
        },
        {
            ref: 'deviceMainTab',
            selector: 'devicemaintab'
        },
        {
            ref: 'devfoldertabgrid',
            selector: 'DevFolderTab-Grid'
        }
    ],

    onCreateDevice: function(button, e, eOpts) {
        console.log("In onCreateDevice");
        var me = this,
            win = this.getDeviceCreateWindow(),
            form1 = win.down('#newDevice-1').getForm(),
            form2 = win.down('#newDevice-2').getForm();
        if (form1.isValid() && form2.isValid()) {    
            win.setLoading('Submitting...');
            Ext.Ajax.request({
                url: '/api/devices',
                params: Ext.encode({
                    formData1: form1.getValues(),
                    formData2: form2.getValues(),
                    whattoadd: 'addnewdevice'
                }),
                headers: {'Accept':'application/vnd.neodocapi.v1' },
                method: 'POST',
                success: function(result, action) {
                    Ext.Msg.alert('Created device successfully!');
                    win.setLoading(false);
                    win.destroy();
                    var grid = Ext.getCmp(JSON.parse(action.params).formData1.callerid);
                    grid.setLoading(true);
                    grid.getStore().reload();
                    grid.setLoading(false);
                },
                failure: function(result, action) {
                    Ext.Msg.alert('Failed to create device!\n\n'+result);
                    win.setLoading(false);
                }
            });
        }
    },

    onDeviceShowFromFolder: function(dataview, record, item, index, e, eOpts) {
        console.log("Double click");
        console.log(record);

        var maintab = Ext.getCmp('mainviewport').down('#locationtabpanel'),
            activetab = maintab.activeTab;



        var found = false;

        maintab.query().map(function(item) {
            if(item.itemId == 'DeviceTab-GeneralPanel-'+record.data.id) {
                console.log('Found match');
                console.log(item);
                found = true;
                item.ownerCt.setActiveTab(item);
            }
        });

        var generaltab;

        if(!found) {

            maintab.setLoading(true);
            generaltab = this.createDeviceDisplayTab(record.data,false);
            activetab.add(generaltab);


            activetab.setActiveTab(generaltab);
            maintab.setLoading(false);

            console.log('Created new device tab and displayed it');
        } 
    },

    onAddDeviceIpAddress: function(button, e, eOpts) {
        console.log('In onAddDeviceIpAddress');

        var win=Ext.create('NeoDoc.view.device.selectIpWin');

        //var treegridstore = Ext.create('NeoDoc.store.NetworkIpTreeStore');

        var owner = button.ownerCt.ownerCt.ownerCt,
            ownerid = owner.id.split("-")[2],
            //    ownerlocationid = owner.ownerCt.ownerCt.id.split("-")[1],
            grid = button.ownerCt.ownerCt,
            gridstore = grid.getStore(),

            treegrid = win.down('#deviceIpTreeGrid'),
            treegridstore = treegrid.getStore(),
            gridform = win.down('#deviceIpTreeGridForm').getForm();


        //    treegrid.getView().store = treegridstore;

        treegridstore.getProxy().extraParams.whattoget='getdevicenetworktree';
        treegridstore.getProxy().extraParams.deviceid=ownerid;
        // treegridstore.getProxy().extraParams.locid=ownerlocationid;

        treegridstore.load();

        gridform.findField('pidId').setValue(ownerid);


        // Create new store
        /*
        var newRootNode =
        {
        id: ownerlocationid,
        expanded: true,
        leaf:false,
        text: "Root",
        children: treegridstore.data
        };


        */
        // Use root of new store
        //  treegrid.setRootNode(newRootNode);

        //	treegridstore.getRootNode().setId(ownerlocationid);



        win.show();

        console.log('Window opened');
        //	treegridstore.load();


        /*
        treegridstore.load({
        callback : function(records, operation, success) {
        console.log(records); 
        win.show();
        }
        });



        */
    },

    onDeviceIpTreeSubmitFn: function(button, e, eOpts) {
        console.log("on Device Submit");



        var me = this,
            win = Ext.getCmp('deviceselctipwin'),
            form = win.down('#deviceIpTreeGridForm').getForm();

        if (form.isValid()) {    
            win.setLoading('Submitting...');
            Ext.Ajax.request({
                url: '/api/devices',
                params: Ext.encode({
                    formData: form.getValues(),
                    whattoadd: 'addipaddress'
                }),
                headers: {'Accept':'application/vnd.neodocapi.v1' },
                method: 'POST',
                success: function(result, action) {
                    Ext.Msg.alert('Added IP to Device successfully!');
                    win.setLoading(false);
                    win.destroy();
                    /*            var grid = Ext.getCmp(JSON.parse(action.params).formData1.callerid);
                    grid.setLoading(true);
                    grid.getStore().reload();
                    grid.setLoading(false); */
                },
                failure: function(result, action) {
                    Ext.Msg.alert('Failed to add IP device!\n\n'+result);
                    win.setLoading(false);
                }
            });
        }
    },

    onNewdevicetab: function(record) {
        console.log('in onNewdevicetab');
        console.log(record);

        var me = this,
            maintab = Ext.getCmp('mainviewport').down('#locationtabpanel');


        var data,
            found = false,
            generalTab;

        maintab.query().map(function(item) {
            if(item.itemId == 'DeviceTab-GeneralPanel-'+record.id) {
                console.log('Found match');
                console.log(item);
                found = true;
                item.ownerCt.setActiveTab(item);
            }
        });

        if(!found) {

            Ext.Ajax.request({
                url: '/api/devices',
                params: {
                    action: "index",
                    whattoget: "getdevice",
                    deviceid: record.id
                },
                headers: {'Accept':'application/vnd.neodocapi.v1' },
                method: 'GET',
                success: function(result, action) {
                    console.log(Ext.decode(result.responseText));
                    data = Ext.decode(result.responseText);
                    generalTab = me.createDeviceDisplayTab(data,true);
                    maintab.add(generalTab);
                    maintab.setActiveTab(generatlTab);
                },
                failure: function(result, action) {
                    Ext.Msg.alert('Failed to get device!\n\n'+result);
                    win.setLoading(false);
                }
            });
        } else {
            maintab.setActiveTab(maintab.down('#DeviceTab-GeneralPanel-'+record.id));
        }





    },

    onNewdevicefoldertab: function(record) {
        var me = this,
            maintab = Ext.getCmp('mainviewport').down('#locationtabpanel');

        console.log('in onNewdevicefoldertab');
        console.log(record);

        console.log('panelId=DevFolderTab-'+record.parentId);

        var tab = maintab.getChildByElement('DevFolderTab-'+record.parentId);

        if(!tab) {

            maintab.setLoading(true);

            var devstore = Ext.create('NeoDoc.store.DeviceFolderStore');

            devstore.storeId= 'DeviceFolderStore-'+record.parentId;
            devstore.defaultRootId= record.parentId;

            devstore.removeAll();


            var devfoldertab = Ext.create('NeoDoc.view.network.MainTabPanel', {
                title: 'Devices - '+record.parentName,
                id: 'DevFolderTab-'+record.parentId,
                itemId: 'DevFolderTab-'+record.parentId,
                cls: 'DeviceFolder',
                closable: true
            });


            Ext.define('NeoDoc.view.device.override.FolderGrid', {    
                override: 'NeoDoc.view.device.FolderGrid',
                plugins: [{ 
                    ptype: 'rowexpander',
                    rowBodyTpl : new Ext.XTemplate(
                    '<span><p><b>OS:</b><tpl for="operatingsystem">{name}</tpl> <tpl for="osversion">{name}</tpl></p></span>',
                    '<span><b>IP Address:</b> <tpl for="ipnumbers">{ipv4} </tpl></span>'

                    )

                }]
            }); 


            var devfoldergrid = Ext.create('NeoDoc.view.device.FolderGrid', {
                title: 'All Devices',
                id: 'DevFolderTab-Grid'+record.parentId,
                cls: 'DeviceFolder',
                store: devstore,
                closable: false,
                dockedItems: [
                {
                    xtype: 'pagingtoolbar',
                    dock: 'bottom',
                    width: 360,
                    displayInfo: true,
                    store: devstore

                }
                ]
            });

            devfoldergrid.getView().id = 'DevFolderTab-GridView'+record.parentId;


            devstore.getProxy().extraParams.whattoget='getlocationdevices';
            devstore.getProxy().extraParams.locationid=record.parentId;


            //        ipgridpage.bindStore(ipstore);
            //        ipgrid.reconfigure(ipstore);

            devstore.loadPage(1);

            devfoldertab.add(devfoldergrid);

            maintab.add(devfoldertab);

            maintab.setActiveTab(devfoldertab);
            maintab.setLoading(false);
        } else {
            maintab.setActiveTab(tab);
        }


    },

    onItemDblClick: function(dataview, record, item, index, e, eOpts) {
        console.log('In Item Dbl Click with record '+record);

        var parent = this.getBubbleParent();


    },

    createDeviceDisplayTab: function(record, closeabletab) {
        console.log(record);




        var generaltab = Ext.create('Ext.panel.Panel', {
            title: 'Device - '+record.name,
            id: 'DeviceTab-GeneralPanel-'+record.id,
            itemId: 'DeviceTab-GeneralPanel-'+record.id,
            cls: 'Device',
            closeable: closeabletab, 
            layout: {
                type: 'accordion'
            }
        });



        var generalinfo = Ext.create('NeoDoc.view.device.GeneralPanel', {
            title: 'General Info',
            id: 'DeviceTab-GeneralInfoPanel-'+record.id,
            itemId: 'DeviceTab-GeneralInfoPanel-'+record.id,
            cls: 'Device',
            resizeable: true
        });

        generaltab.add(generalinfo);

        if(record.ipnumbers) {
            var netstore = Ext.create('NeoDoc.store.DeviceNetworkInfoStore');
            netstore.storeId = 'DeviceNetworkInfoStore-'+record.id;


            var ippanel = Ext.create('NeoDoc.view.device.IpNumberPanel', {
                title: 'IpNumbers',
                id: 'DeviceTab-Ipnumber-'+record.id,
                itemId: 'DeviceTab-Ipnumber-'+record.id,
                cls: 'Device',
                closable: false,
                layout: {
                    type: 'border'
                }
            });


            var ipgrid = Ext.create('NeoDoc.view.device.IpNumberGrid', {
                title: 'IpNumberGrid',
                region: 'center',
                flex: 1,
                id: 'DeviceTab-IpnumberGrid-'+record.id,
                cls: 'Device',
                store: netstore,
                closable: false,
                dockedItems: [
                {
                    xtype: 'pagingtoolbar',
                    itemId: 'IpNumberGridToolbar',
                    dock: 'bottom',
                    displayInfo: true,
                    store: netstore,
                    items: [
                    {
                        xtype: 'button',
                        itemId: 'adddeviceipaddressbtn',
                        iconCls: 'network-icon',
                        text: 'Add IP Address',
                        action: 'deviceaddipaddress'
                    }
                    ]
                }
                ]
            });        

            var netinfopanel = Ext.create('NeoDoc.view.device.NetworkInfoPanel', {
                title: 'Network Info',
                region: 'south',
                flex: 2,
                id: 'DeviceTab-Info-'+record.id,
                itemId: 'DeviceTab-Info-'+record.id,
                cls: 'Device',
                closable: false
            });

            ippanel.add(ipgrid);
            ippanel.add(netinfopanel);


            netstore.getProxy().extraParams.whattoget='getdevicenetwork';
            netstore.getProxy().extraParams.deviceid=record.id;

            netstore.load({
                callback : function(records, operation, success) {
                    console.log(records); 
                    netinfopanel.data = record.ipnumbers[0].network;
                    netinfopanel.update(record.ipnumbers[0].network);
                }
            });


            generaltab.add(ippanel);

        }    



        generaltab.add(Ext.create('Ext.panel.Panel', {
            title: 'Comments',
            id: 'DeviceTab-GeneralTestPanel-'+record.id,
            itemId: 'DeviceTab-GeneralTestPanel-'+record.id,
            cls: 'Device'

        }));

        generaltab.add(Ext.create('Ext.panel.Panel', {
            title: 'Related documents',
            id: 'DeviceTab-GeneralDocumentPanel-'+record.id,
            itemId: 'DeviceTab-GeneralDocumentPanel-'+record.id,
            cls: 'Device'

        }));

        generalinfo.data = record;
        generalinfo.update(record);

        return generaltab;



    },

    init: function(application) {
        this.control({
            "devicecreatewindow button[action=newdevice]": {
                click: this.onCreateDevice
            },
            "#devfoldertabgrid": {
                itemdblclick: this.onDeviceShowFromFolder
            },
            "#IpNumberGridToolbar button[action=deviceaddipaddress]": {
                click: this.onAddDeviceIpAddress
            },
            "#deviceIpTreeGridFormToolBar button[action=addipaddressbtn]": {
                click: this.onDeviceIpTreeSubmitFn
            }
        });

        application.on({
            newdevicetab: {
                fn: this.onNewdevicetab,
                scope: this
            },
            newdevicefoldertab: {
                fn: this.onNewdevicefoldertab,
                scope: this
            }
        });
    }

});
